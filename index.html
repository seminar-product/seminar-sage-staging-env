<!DOCTYPE html>
<html>
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KMGCGNZ3');</script>
    <!-- End Google Tag Manager -->
    <title>Seminar Sage</title>
    <link href="https://fonts.googleapis.com/css2?family=Mulish&display=swap" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #voiceflow-container {
            border: none; /* Remove iframe border if desired */
            width: 100vw;  /* Full viewport width */
            height: 100vh; /* Full viewport height */
            position: fixed;
            top: 0;
            left: 0;
            font-family: 'Mulish', sans-serif !important;
        }
    </style>
    <!-- DOCX converter -->
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
     <!-- EXCEL converter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KMGCGNZ3"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="voiceflow-container"></div>
    <script type="text/javascript">
      (function(d, t) {
          var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
          v.onload = function() {
            window.voiceflow.chat.load({
              verify: { projectID: '67e57c8960fe7e4d365d966a' },
              url: 'https://general-runtime.voiceflow.com',
              versionID: 'staging',
              voice: {
                url: "https://runtime-api.voiceflow.com"
             },
       	 assistant: {
             stylesheet: "chat-style.css", 
        	 extensions: [FileUploadExtension]
     	     },
              render: {
                mode: 'embedded',
                target: document.getElementById('voiceflow-container')
              }
            });
          }
          v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; 
          v.type = "text/javascript"; 
          s.parentNode.insertBefore(v, s);

            // ðŸ“¦ Define the FileUploadExtension
          const FileUploadExtension = {
              name: 'FileUpload',
              type: 'response',
              match: ({ trace }) =>
                trace.type === 'ext_csvFileUpload' ||
                trace.payload?.name === 'ext_csvFileUpload',
            
              render: ({ trace, element }) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = trace.payload.accepted || '*/*';
                input.multiple = true;
            
                input.onchange = () => {
                  const files = Array.from(input.files || []);
                  const MAX_SIZE = 3 * 1024 * 1024; // 3 MB
            
                  const validFiles = files.filter(file => {
                    if (file.size > MAX_SIZE) {
                      alert(`File "${file.name}" is too large. Max size is 3MB.`);
                      return false;
                    }
                    return true;
                  });
            
                  if (validFiles.length === 0) return;
            
                  const fileReadPromises = validFiles.map(file => {
                    return new Promise((resolve, reject) => {
                      const reader = new FileReader();
            
                      reader.onload = () => {
                        try {
                          const base64 = reader.result.split(',')[1];
                          let fileData;
            
                          // ----------------------------------------------------
                          // DOCX â†’ TEXT 
                          // ----------------------------------------------------
                          const isDocx =
                            file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" ||
                            file.name.toLowerCase().endsWith(".docx");
            
                          if (file.type.startsWith("text/")) {
                            // CSV, TXT â†’ decode safely
                            fileData = atob(base64);
            
                            resolve({
                              fileName: file.name,
                              fileType: file.type,
                              fileData
                            });
                            return;
                          }
            
                          if (isDocx) {
                            const arrayBuffer = Uint8Array.from(
                              atob(base64),
                              c => c.charCodeAt(0)
                            ).buffer;
            
                            if (typeof mammoth !== "undefined") {
                              mammoth.extractRawText({ arrayBuffer })
                                .then(result => {
                                  resolve({
                                    fileName: file.name,
                                    fileType: "text/plain",
                                    fileData: result.value
                                  });
                                })
                                .catch(err => {
                                  console.error("DOCX conversion failed:", err);
                                  resolve({
                                    fileName: file.name,
                                    fileType: "text/plain",
                                    fileData: "[Could not extract text from DOCX]"
                                  });
                                });
                            } else {
                              resolve({
                                fileName: file.name,
                                fileType: "text/plain",
                                fileData: "[Mammoth library missing]"
                              });
                            }
                            return;
                          }
            
                          // ----------------------------------------------------
                          // XLS / XLSX â†’ CSV extraction
                          // ----------------------------------------------------
                          const isExcel =
                            file.name.toLowerCase().endsWith(".xlsx") ||
                            file.name.toLowerCase().endsWith(".xls");
            
                          if (isExcel) {
                            try {
                              const binary = atob(base64);
                              const workbook = XLSX.read(binary, { type: "binary" });
                              const sheetName = workbook.SheetNames[0];
                              const sheet = workbook.Sheets[sheetName];
            
                              const csv = XLSX.utils.sheet_to_csv(sheet);
            
                              resolve({
                                fileName: file.name,
                                fileType: "text/plain",
                                fileData: csv
                              });
                            } catch (err) {
                              console.error("Excel conversion failed:", err);
                              resolve({
                                fileName: file.name,
                                fileType: "text/plain",
                                fileData: "[Could not extract text from Excel]"
                              });
                            }
            
                            return; // prevent double resolve
                          }
            
                          // ----------------------------------------------------
                          // Everything else â†’ base64
                          // ----------------------------------------------------
                          fileData = base64;
            
                          resolve({
                            fileName: file.name,
                            fileType: file.type,
                            fileData
                          });
            
                        } catch (err) {
                          reject(err);
                        }
                      };
            
                      reader.onerror = reject;
                      reader.readAsDataURL(file);
                    });
                  });
            
                  Promise.all(fileReadPromises)
                    .then(filePayloads => {
                      window.voiceflow.chat.interact({
                        type: 'complete',
                        payload: { files: filePayloads }
                      });
                    })
                    .catch(err => {
                      alert("Error reading one or more files.");
                      console.error(err);
                    });
                };
                element.appendChild(input);
              }
            };
          })(document, 'script');
</script>
</body>
</html>
